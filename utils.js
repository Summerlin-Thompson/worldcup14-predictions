
var data = {"games": [

  {"id": 1, "date": "Thu Jun 12 2014 21:00 GMT", "home": "Brazil", "away": "Croatia", "location":"Sao Paulo", "scoreHome": 0, "scoreAway": 0},
  {"id": 2, "date": "Fri Jun 13 2014 17:00 GMT", "home": "Mexico", "away": "Cameroon", "location":"Natal", "scoreHome": 0, "scoreAway": 0},
  {"id": 3, "date": "Fri Jun 13 2014 20:00 GMT", "home": "Spain", "away": "Netherlands", "location": "Salvador"},
  {"id": 4, "date": "Fri Jun 13 2014 23:00 GMT", "home": "Chile", "away": "Australia", "location":"Curitiba"},
  {"id": 5, "date": "Sat Jun 14 2014 17:00 GMT", "home": "Colombia", "away": "Greece", "location":"Belo Horizonte"},    
  {"id": 6, "date": "Sun Jun 15 2014 02:00 GMT", "home": "Ivory Coast", "away": "Japan", "location":"Recife"},    
  {"id": 7, "date": "Sat Jun 14 2014 20:00 GMT", "home": "Uruguay", "away": "Costa Rica", "location":"Fortaleza"},   
  {"id": 8, "date": "Sat Jun 14 2014 23:00 GMT", "home": "England", "away": "Italy", "location":"Manaus"},    
  {"id": 9, "date": "Sun Jun 15 2014 17:00 GMT", "home": "Switzerland", "away": "Ecuador", "location":"Brasilia"},    
 {"id": 10, "date": "Sun Jun 15 2014 20:00 GMT", "home": "France", "away": "Honduras", "location":"Porto Alegre"},  
 {"id": 11, "date": "Sun Jun 15 2014 23:00 GMT", "home": "Argentina",      "away": "Bosnia and Herzegovina", "location":"Rio De Janeiro"}, 
 {"id": 12, "date": "Mon Jun 16 2014 20:00 GMT", "home": "Iran",           "away": "Nigeria", "location":"Curitiba"},     
 {"id": 13, "date": "Mon Jun 16 2014 17:00 GMT", "home": "Germany",        "away": "Portugal", "location":"Salvador"},    

 {"id": 14, "date": "Mon Jun 16 2014 23:00 GMT", "home": "Ghana",          "away": "United States", "location":"Natal"},    
 {"id": 15, "date": "Tue Jun 17 2014 17:00 GMT", "home": "Belgium",        "away": "Algeria", "location":"Belo Horizonte"},    
 {"id": 16, "date": "Tue Jun 17 2014 23:00 GMT", "home": "Russia",         "away": "Korea Republic", "location":"Cuiaba"}, 
 {"id": 17, "date": "Tue Jun 17 2014 20:00 GMT", "home": "Brazil",         "away": "Mexico", "location":"Fortaleza"},      
 {"id": 18, "date": "Wed Jun 18 2014 23:00 GMT", "home": "Cameroon",       "away": "Croatia", "location":"Manaus"},     
 {"id": 19, "date": "Wed Jun 18 2014 17:00 GMT", "home": "Australia",      "away": "Netherlands", "location":"Porto Alegre"},     

 {"id": 20, "date": "Wed Jun 18 2014 20:00 GMT", "home": "Spain",          "away": "Chile", "location":"Rio De Janeiro"},     
 {"id": 21, "date": "Thu Jun 19 2014 17:00 GMT", "home": "Colombia",       "away": "Ivory Coast", "location":"Brasilia"},     

 {"id": 22, "date": "Thu Jun 19 2014 23:00 GMT", "home": "Japan",          "away": "Greece", "location":"Natal"},    
 {"id": 23, "date": "Thu Jun 19 2014 20:00 GMT", "home": "Uruguay",        "away": "England", "location":"Sao Paulo"},    
 {"id": 24, "date": "Fri Jun 20 2014 17:00 GMT", "home": "Italy",          "away": "Costa Rica", "location":"Recife"},     
 {"id": 25, "date": "Fri Jun 20 2014 20:00 GMT", "home": "Switzerland",    "away": "France", "location":"Salvador"},     
 {"id": 26, "date": "Fri Jun 20 2014 23:00 GMT", "home": "Honduras",       "away": "Ecuador", "location":"Curitiba"},     
 {"id": 27, "date": "Sat Jun 21 2014 17:00 GMT", "home": "Argentina",      "away": "Iran", "location":"Belo Horizonte"},     
 {"id": 28, "date": "Sat Jun 21 2014 23:00 GMT", "home": "Nigeria",        "away": "Bosnia and Herzegovina", "location":"Cuiaba"},     
 {"id": 29, "date": "Sat Jun 21 2014 20:00 GMT", "home": "Germany",        "away": "Ghana", "location":"Fortaleza"},    


 {"id": 30, "date": "Sun Jun 22 2014 23:00 GMT", "home": "United States",  "away": "Portugal", "location":"Manaus"},     
 {"id": 31, "date": "Sun Jun 22 2014 20:00 GMT", "home": "Korea Republic", "away": "Algeria", "location":"Porto Alegre"},     
 {"id": 32, "date": "Sun Jun 22 2014 17:00 GMT", "home": "Belgium",        "away": "Russia", "location":"Rio De Janeiro"},     

 {"id": 33, "date": "Mon Jun 23 2014 21:00 GMT", "home": "Cameroon",       "away": "Brazil", "location":"Brasilia"},     
 {"id": 34, "date": "Mon Jun 23 2014 21:00 GMT", "home": "Croatia",        "away": "Mexico", "location":"Recife"},     
 {"id": 35, "date": "Mon Jun 23 2014 17:00 GMT", "home": "Australia",      "away": "Spain", "location":"Curitiba"},     
 {"id": 36, "date": "Mon Jun 23 2014 17:00 GMT", "home": "Netherlands",    "away": "Chile", "location":"Sao Paulo"},    

 {"id": 37, "date": "Tue Jun 24 2014 21:00 GMT", "home": "Japan",          "away": "Colombia", "location":"Cuiaba"},     
 {"id": 38, "date": "Tue Jun 24 2014 21:00 GMT", "home": "Greece",         "away": "Ivory Coast", "location":"Fortaleza"},    

 {"id": 39, "date": "Tue Jun 24 2014 17:00 GMT", "home": "Costa Rica",     "away": "England", "location":"Belo Horizonte"},    
 {"id": 40, "date": "Tue Jun 24 2014 17:00 GMT", "home": "Italy",          "away": "Uruguay", "location":"Natal"},    


 {"id": 41, "date": "Wed Jun 25 2014 21:00 GMT", "home": "Honduras",      "away": "Switzerland", "location":"Manaus"},     
 {"id": 42, "date": "Wed Jun 25 2014 21:00 GMT", "home": "Ecuador",       "away":  "France", "location":"Rio De Janeiro"},     
 {"id": 43, "date": "Wed Jun 25 2014 17:00 GMT", "home": "Nigeria",        "away": "Argentina", "location":"Porto Alegre"},     
 {"id": 44, "date": "Wed Jun 25 2014 17:00 GMT", "home": "Bosnia and Herzegovina", "away": "Iran", "location":"Salvador"},     

 {"id": 45, "date": "Thu Jun 26 2014 17:00 GMT", "home": "United States",    "away":  "Germany", "location":"Recife"},     
 {"id": 46, "date": "Thu Jun 26 2014 17:00 GMT", "home": "Portugal",      "away": "Ghana", "location":"Brasilia"},     

 {"id": 47, "date": "Thu Jun 26 2014 21:00 GMT", "home": "Algeria",       "away":   "Russia", "location":"Curitiba"},
 {"id": 48, "date": "Thu Jun 26 2014 21:00 GMT", "home": "Korea Republic","away": "Belgium", "location":"Sao Paulo"},    
 {"id": 49, "date": "Sat Jun 28 2014 17:00 GMT", "home": "1A",            "away": "2B", "location":"Belo Horizonte"},
 {"id": 50, "date": "Sat Jun 28 2014 21:00 GMT", "home": "1C",            "away": "2D", "location":"Rio De Janeiro"},
 {"id": 51, "date": "Sun Jun 29 2014 17:00 GMT", "home": "1B",            "away": "2A", "location":"Fortaleza"},
 {"id": 52, "date": "Sun Jun 29 2014 21:00 GMT", "home": "1D",            "away": "2C", "location":"Recife"},
 {"id": 53, "date": "Mon Jun 30 2014 17:00 GMT", "home": "1E",            "away": "2F", "location":"Brasilia"},
 {"id": 54, "date": "Mon Jun 30 2014 21:00 GMT", "home": "1G",            "away": "2H", "location":"Porto Alegre"},
 {"id": 55, "date": "Tue Jul 1  2014 17:00 GMT", "home": "1F",            "away": "2E", "location":"Sao Paulo"},
 {"id": 56, "date": "Tue Jul 1  2014 21:00 GMT", "home": "1H",            "away": "2G", "location":"Salvador"},
 {"id": 57, "date": "Fri Jul 4  2014 21:00 GMT", "home": "W49",           "away": "W50", "location":"Fortalezar"},
 {"id": 58, "date": "Sat Jul 5  2014 21:00 GMT", "home": "W51",           "away": "W52", "location":"Salvadorr"},
 {"id": 59, "date": "Fri Jul 4  2014 17:00 GMT", "home": "W53",           "away": "W54", "location":"Rio De Janeiror"},
 {"id": 60, "date": "Sat Jul 5  2014 17:00 GMT", "home": "W55",           "away": "W56", "location":"Brasiliar"},
 {"id": 61, "date": "Tue Jul 8  2014 21:00 GMT", "home": "W57",           "away": "W58", "location":"Belo Horizonter"},
 {"id": 62, "date": "Wed Jul 9  2014 21:00 GMT", "home": "W59",           "away": "W60", "location":"Sao Paulor"},
 {"id": 63, "date": "Thu Jul 13 2014 16:00 GMT", "home": "W61",           "away": "W62", "location":"Rio De Janeiro"},
 {"id": 64, "date": "Sat Jul 12 2014 21:00 GMT", "home": "L61",           "away": "L62", "location":"Brasilia"}],

 "teams":[
  {"team": "Brazil", "group": "A", "alias":"BRA", "population":205716890, "gdp":2282000, "continent":"South America"},
  {"team": "Croatia", "group": "A", "alias":"HRV"},
  {"team": "Mexico", "group": "A", "alias":"MEX", "population":114975406, "gdp":1657000, "continent":"North America"},
  {"team": "Cameroon", "group": "A", "alias":"CMR"},

  {"team": "Spain", "group": "B", "alias":"ESP"},
  {"team": "Netherlands", "group": "B", "alias":"NLD"},
  {"team": "Chile", "group": "B", "alias":"CHL"},
  {"team": "Australia", "group": "B", "alias":"AUS"},

  {"team": "Colombia", "group": "C", "alias":"COL"},
  {"team": "Greece", "group": "C", "alias":"GRC"},
  {"team": "Ivory Coast", "group": "C", "alias":"CIV"},
  {"team": "Japan", "group": "C", "alias":"JPN"},

  {"team": "Uruguay", "group": "D", "alias":"URY"},
  {"team": "Costa Rica", "group": "D", "alias":"CRI"},
  {"team": "England", "group": "D", "alias":"ENG"},
  {"team": "Italy", "group": "D", "alias":"ITA"},

  {"team": "Switzerland", "group": "E", "alias":"CHE"},
  {"team": "Ecuador", "group": "E", "alias":"ECU"},
  {"team": "France", "group": "E", "alias":"FRA"},
  {"team": "Honduras", "group": "E", "alias":"HND"},

  {"team": "Argentina", "group": "F", "alias":"ARG"},
  {"team": "Bosnia and Herzegovina", "group": "F", "alias":"BIH"},
  {"team": "Iran", "group": "F", "alias":"IRN"},
  {"team": "Nigeria", "group": "F", "alias":"NER"},

  {"team": "Germany", "group": "G", "alias":"DEU"},
  {"team": "Portugal", "group": "G", "alias":"PRT"},
  {"team": "Ghana", "group": "G", "alias":"GHA"},
  {"team": "United States", "group": "G", "alias":"USA"},

  {"team": "Belgium", "group": "H", "alias":"BEL"},
  {"team": "Algeria", "group": "H", "alias":"DZA"},
  {"team": "Russia", "group": "H", "alias":"RUS"},
  {"team": "Korea Republic", "group": "H", "alias":"KOR"}
]};

var unique_groups = d3.set(data.teams.map(function(d) { return d.group;})).values();

function team_in_teams(team, teams) {
  var index_team = data.teams.map(function(d) { return d.team; }).indexOf(team);
  return teams[index_team] > 0;
} 

function find_team_alias(t) {
  return data.teams.filter(function(d) { return d.team == t })[0].alias;
}

function find_team_data_by_alias(t) {
  return data.teams.filter(function(d) { return d.alias == t })[0];
}

var all_paths = [

  // Winner
  ["W64", "W61", "W57", "W49", "1A", "r1A"],
  ["W64", "W61", "W57", "W49", "2B", "r2B"],

  ["W64", "W61", "W57", "W50", "1C", "r1C"],
  ["W64", "W61", "W57", "W50", "2D", "r2D"],

  ["W64", "W61", "W58", "W51", "1B", "r1B"],
  ["W64", "W61", "W58", "W51", "2A", "r2A"],

  ["W64", "W61", "W58", "W52", "1D", "r1D"],
  ["W64", "W61", "W58", "W52", "2C", "r2C"],

  ["W64", "W62", "W59", "W53", "1E", "r1E"],
  ["W64", "W62", "W59", "W53", "2F", "r2F"],

  ["W64", "W62", "W59", "W54", "1G", "r1G"],
  ["W64", "W62", "W59", "W54", "2H", "r2H"],
  
  ["W64", "W62", "W60", "W55", "1F", "r1F"],
  ["W64", "W62", "W60", "W55", "2E", "r2E"],
  
  ["W64", "W62", "W60", "W55", "1H", "r1H"],
  ["W64", "W62", "W60", "W55", "2G", "r2G"],

  // Runner up
  ["L64", "W61", "W57", "W49", "1A", "r1A"], 
  ["L64", "W61", "W57", "W49", "2B", "r2B"], 

  ["L64", "W61", "W57", "W50", "1C", "r1C"],
  ["L64", "W61", "W57", "W50", "2D", "r2D"],

  ["L64", "W61", "W58", "W51", "1B", "r1B"],
  ["L64", "W61", "W58", "W51", "2A", "r2A"],

  ["L64", "W61", "W58", "W52", "1D", "r1D"],
  ["L64", "W61", "W58", "W52", "2C", "r2C"],

  ["L64", "W62", "W59", "W53", "1E", "r1E"],
  ["L64", "W62", "W59", "W53", "2F", "r2F"],

  ["L64", "W62", "W59", "W54", "1G", "r1G"],
  ["L64", "W62", "W59", "W54", "2H", "r2H"],
  
  ["L64", "W62", "W60", "W55", "1F", "r1F"],
  ["L64", "W62", "W60", "W55", "2E", "r2E"],
  
  ["L64", "W62", "W60", "W56", "1H", "r1H"],
  ["L64", "W62", "W60", "W56", "2G", "r2G"],

  // 3rd place
  ["W63", "L61", "W57", "W49", "1A", "r1A"], 
  ["W63", "L61", "W57", "W49", "2B", "r2B"],   
  
  ["W63", "L61", "W57", "W50", "1C", "r1C"],
  ["W63", "L61", "W57", "W50", "2D", "r2D"],

  ["W63", "L61", "W58", "W51", "1B", "r1B"],
  ["W63", "L61", "W58", "W51", "2A", "r2A"],

  ["W63", "L61", "W58", "W52", "1D", "r1D"], 
  ["W63", "L61", "W58", "W52", "2C", "r2C"],

  ["W63", "L62", "W59", "W53", "1E", "r1E"],
  ["W63", "L62", "W59", "W53", "2F", "r2F"],

  ["W63", "L62", "W59", "W54", "1G", "r1G"],
  ["W63", "L62", "W59", "W54", "2H", "r2H"],

  ["W63", "L62", "W60", "W55", "1F", "r1F"],
  ["W63", "L62", "W60", "W55", "2E", "r2E"],

  ["W63", "L62", "W60", "W56", "1H", "r1H"],
  ["W63", "L62", "W60", "W56", "2G", "r2G"],

  // 4th place
  ["L63", "L61", "W57", "W49", "1A", "r1A"], 
  ["L63", "L61", "W57", "W49", "2B", "r2B"],     
  
  ["L63", "L61", "W57", "W50", "1C", "r1C"],
  ["L63", "L61", "W57", "W50", "2D", "r2D"],

  ["L63", "L61", "W58", "W51", "1B", "r1B"],
  ["L63", "L61", "W58", "W51", "2A", "r2A"],

  ["L63", "L61", "W58", "W52", "1D", "r1D"],
  ["L63", "L61", "W58", "W52", "2C", "r2C"],

  ["L63", "L62", "W59", "W53", "1E", "r1E"],
  ["L63", "L62", "W59", "W53", "2F", "r2F"],

  ["L63", "L62", "W59", "W54", "1G", "r1G"],
  ["L63", "L62", "W59", "W54", "2H", "r2H"],
 
  ["L63", "L62", "W60", "W55", "1F", "r1F"], 
  ["L63", "L62", "W60", "W55", "2E", "r2E"], 
 
  ["L63", "L62", "W60", "W56", "1H", "r1H"], 
  ["L63", "L62", "W60", "W56", "2G", "r2G"], 

  // Loosers 1/4 finals
  ["XXX", "XXX", "L57", "W49", "1A", "r1A"], 
  ["XXX", "XXX", "L57", "W49", "2B", "r2B"],    
  
  ["XXX", "XXX", "L57", "W50", "1C", "r1C"],
  ["XXX", "XXX", "L57", "W50", "2D", "r2D"],

  ["XXX", "XXX", "L58", "W51", "1B", "r1B"],
  ["XXX", "XXX", "L58", "W51", "2A", "r2A"],

  ["XXX", "XXX", "L58", "W52", "1D", "r1D"],
  ["XXX", "XXX", "L58", "W52", "2C", "r2C"],

  ["XXX", "XXX", "L59", "W53", "1E", "r1E"],
  ["XXX", "XXX", "L59", "W53", "2F", "r2F"],

  ["XXX", "XXX", "L59", "W54", "1G", "r1G"],
  ["XXX", "XXX", "L59", "W54", "2H", "r2H"],

  ["XXX", "XXX", "L60", "W55", "1F", "r1F"], 
  ["XXX", "XXX", "L60", "W55", "2E", "r2E"], 

  ["XXX", "XXX", "L60", "W56", "1H", "r1H"], 
  ["XXX", "XXX", "L60", "W56", "2G", "r2G"], 

  // Loosers 1/8 finals
  ["XXX", "XXX", "XXX", "L56", "1H", "r1H"], 
  ["XXX", "XXX", "XXX", "L56", "2G", "r2G"],

  ["XXX", "XXX", "XXX", "L55", "1F", "r1F"], 
  ["XXX", "XXX", "XXX", "L55", "2E", "r2E"],

  ["XXX", "XXX", "XXX", "L54", "1G", "r1G"],
  ["XXX", "XXX", "XXX", "L54", "2H", "r2H"],

  ["XXX", "XXX", "XXX", "L53", "1E", "r1E"],
  ["XXX", "XXX", "XXX", "L53", "2F", "r2F"],

  ["XXX", "XXX", "XXX", "L52", "1D", "r1D"],
  ["XXX", "XXX", "XXX", "L52", "2C", "r2C"],

  ["XXX", "XXX", "XXX", "L51", "1B", "r1B"],
  ["XXX", "XXX", "XXX", "L51", "2A", "r2A"],

  ["XXX", "XXX", "XXX", "L50", "1C", "r1C"],
  ["XXX", "XXX", "XXX", "L50", "2D", "r2D"],

  ["XXX", "XXX", "XXX", "L49", "1A", "r1A"],       
  ["XXX", "XXX", "XXX", "L49", "2B", "r2B"],

  ["XXX", "XXX", "XXX", "XXX", "r3A"],
  ["XXX", "XXX", "XXX", "XXX", "r4A"],
  ["XXX", "XXX", "XXX", "XXX", "r3B"],
  ["XXX", "XXX", "XXX", "XXX", "r4B"],
  ["XXX", "XXX", "XXX", "XXX", "r3C"],
  ["XXX", "XXX", "XXX", "XXX", "r4C"],
  ["XXX", "XXX", "XXX", "XXX", "r3D"],
  ["XXX", "XXX", "XXX", "XXX", "r4D"],
  ["XXX", "XXX", "XXX", "XXX", "r3E"],
  ["XXX", "XXX", "XXX", "XXX", "r4E"],
  ["XXX", "XXX", "XXX", "XXX", "r3F"],
  ["XXX", "XXX", "XXX", "XXX", "r4F"],
  ["XXX", "XXX", "XXX", "XXX", "r3G"],
  ["XXX", "XXX", "XXX", "XXX", "r4G"],
  ["XXX", "XXX", "XXX", "XXX", "r3H"],
  ["XXX", "XXX", "XXX", "XXX", "r4H"],
];


// Extends paths to rankings

var list_extensions = [];

all_paths.forEach(function(d, i) {
  d.forEach(function(e, j) {
    unique_groups.forEach(function(g) {

      // If contains the current group
      if(e.indexOf(g)!=-1) {


       // Pre-pending "ESP3", "ESP2", "ESP1", "ESP0"
        var a = find_teams_by_group(g).map(function(a, n) { 
          return d3.range(4).map(function(b, c) { 
            return a.alias + (3-b); 
          }) 
        })

        var group_1 = d.map(function(c) { return c; });
        a[0].map(function(f) { group_1.push(f) });
        list_extensions.push(group_1);


        var group_2 = d.map(function(c) { return c; });
        a[1].map(function(f) { group_2.push(f) });
        list_extensions.push(group_2);

        var group_3 = d.map(function(c) { return c; });
        a[2].map(function(f) { group_3.push(f) });
        list_extensions.push(group_3);

        var group_4 = d.map(function(c) { return c; });
        a[3].map(function(f) { group_4.push(f) });
        list_extensions.push(group_4);

      //  a[0].map(function(f) { d.push(f) });

      }
    })
  });
})

//var flat_all_paths = [];
//all_paths.map(function(d) { flat_all_paths = flat_all_paths.concat(d); });


/*
// Remove the XXX placeholders
all_end_games = all_end_games.filter(function(d) { return d != "XXX"; });

var all_end_games = all_end_games.filter(function(d){
  //return test(d);
});
*/

// Merge other groups with all paths + group 1
all_paths = list_extensions; //all_paths.concat(list_extensions);


var all_end_games = all_paths.map(function(d, i) {

  return find_latest_game_path(d);

})

// Unique
var all_end_games = all_end_games.filter(function(d,i,a){
  return i==a.indexOf(d);
});


function get_all_end_games() {

}

var current_prediction = []// ["W62", "FRA"],  ["W61", "BRA"] ];

current_prediction.forEach(function(d) { 

  if(d[1] != "") { // If we made a prediction for the given team

    all_paths = all_paths.filter(function(e) {

      // All the paths with the current country
      if(e.indexOf(d[1]+"0") != -1) {   // Select team
        if(e.indexOf(d[0]) == -1) {     // Select the right place
         console.log("remove team paths", e, d[1], d[0])
        } else {
          return e;
        }
      
      } else if(e.indexOf(d[0]) != -1) {
       
        if(e.indexOf(d[1]+"0") == -1) {
         console.log("remove others paths", e, d[1], d[0])
        } else {
          return e;
        }

      } else {
        return e;
      }

    })
    
  }
})

var svgLine = d3.svg.line()
                    .x(function(d) {return d[0]; })
                    .y(function(d) { return d[1] + 15*Math.random(); })
                    .interpolate("basis"); // basis

function create_paths(canvas) {


  if (typeof canvas === 'undefined') {
    canvas = svg;
  } 

  states_paths = d3.range(all_paths.length).map(function() { return 0; });

  // Required for dragit
  gDragit = svg.insert("g").attr("class", "gDragit")

  all_paths.map(function(d, i) {

    
    var list_coordinates = all_paths[i].map(function(d) { return get_team_coordinates(d); })
                                       .filter(function(d) { return d == null ? false: true;})


    dragit.lineGraph = canvas.selectAll("#path_"+i)
                    .data([list_coordinates])
                  .enter().append("path")
                    .attr("d", svgLine)
                    .style("stroke", "#000")
                    .attr("stroke-width", 1)    
                    .style("opacity", .1)                        
                    .attr("id", "path_"+i)
                    .style("display", "none")


   })

  update_paths("CREATE_PATHS");
}

// 0 - Not visible (when 2, 3 or 4)
// 1 - Occupied by a team
// 2 - Visible lines (SHOW_GAME, SHOW_TEAM)
// 3 - Trail line (DRAG)
// 4 - Trail Focus line (DRAG CURRENT) -> RED
// 5 - Show all paths (to generate the background)
// 6 - Occupied path by team from same group
 prevent_second_round = false;

function update_paths(opt, canvas) {

  if(dev)
    console.log("Update paths", opt)

  if (typeof opt === 'undefined') {
    opt = "";
  }

  if (typeof canvas === 'undefined') {
    canvas = svg;
  } 

  // Show with trail the one related to the current selection
  states_paths = d3.range(all_paths.length).map(function() { return 0; });

  if(opt == "SHOW_GAME") {

    var current_game_paths = filter_paths_by_game(current_game, all_paths);

    current_game_paths.map(function(d) {
      states_paths[all_paths.indexOf(d)] = 1;
    })
    // Highlight all the paths for current_team

  }

  if(dragit.statemachine.current_state != "drag" && opt != "SHOW_TEAM" && opt != "SHOW_GAME") {
    //Show all selected paths
    current_prediction.map(function(d) {

      var game_paths = filter_paths_by_game(d[0], all_paths);
      var current_paths = filter_paths_by_team(d[1], game_paths);

      current_paths.map(function(d) {
        states_paths[all_paths.indexOf(d)] = 1;
      })
     
    })
  }

  // Show with focus the currently selected path
  if(dragit.statemachine.current_state == "drag" || opt == "SHOW_TEAM" || opt == "SHOW_PATH") {

    prevent_second_round = false;
    var current_team_paths = filter_paths_by_team(current_team, all_paths);

    // Remove the paths that cannot be taken because of team from same group
    var current_group = find_team_group(current_team);

    var group_teams = find_teams_by_group(current_group);
      
    var selected_teams = group_teams.filter(function(d) { 
      return test_team_in_prediction(d.alias, current_prediction); 
    });


    if(selected_teams.length>=2) {

      var max_second_round = 0;

      selected_teams.forEach(function(t) {
        var predict_game = find_game_by_team_predictions(t.alias, current_prediction)[0];
        if(predict_game != "r3"+current_group && predict_game != "r4"+current_group) {
          max_second_round++;
        }
      })
      if(max_second_round>=2) {
        prevent_second_round = true;

      } 

    }

    current_team_paths.map(function(d) {

        if(all_paths.indexOf(d) == current_path) {

          if(max_second_round && d[3] != "XXX")
            states_paths[all_paths.indexOf(d)] = 4;
          else
            states_paths[all_paths.indexOf(d)] = 4;
       

        }  else {

          if(max_second_round && d[3] != "XXX")
            states_paths[all_paths.indexOf(d)] = 6;
          else
            states_paths[all_paths.indexOf(d)] = 3;
       
      }


    })
    // Highlight all the paths for current_team

  }

  // Show with focus the currently selected path
  if(opt == "SHOW_ALL_PATH") {

    all_paths.map(function(d) {

        states_paths[all_paths.indexOf(d)] = 5;
  
    })
    // Highlight all the paths for current_team

  }

  // Calculate state of each game
  state_games = d3.range(all_end_games.length).map(function() { return 0; });

  // Highlight the focus line
  all_paths.map(function(d, i) {

    var end_game = find_latest_game_path(all_paths[i]);

    if(states_paths[i] > 0) { // Apply style to the paths

      if(states_paths[i]==4 || states_paths[i]==3) 
        state_games[all_end_games.indexOf(end_game)] = Math.max(state_games[all_end_games.indexOf(end_game)], states_paths[i]);

      canvas.selectAll("#path_"+i)
            .attr("stroke-width", function() {
              if(states_paths[i]==4 || states_paths[i]==6)
                return 5;
              else if(states_paths[i]==5)
                return 4;
              else
                return 4;
            })    
            .style("opacity", function() {
              if(states_paths[i]==3 || states_paths[i]==5)
                return .05;
              else if(states_paths[i]==1 || states_paths[i]==6)
                return .2          
              else if(states_paths[i]==4 )
                return .5
              else
                return .1;
            })                        
            .style("display", "block")
            .attr("class", function() {
              if(states_paths[i]==4 || states_paths[i]== 3 || states_paths[i]==6) {
                return "lineTrail";
              } else {
                return ""
              }
            })
            .style("stroke", function() {
              if(states_paths[i]==4) {
                return "gold";
              }
              else if(states_paths[i]==5)
                return "gray"
              else if(states_paths[i]==6)
                return "green"
              else
                return "green"
            })


    } else { // Hide no related paths

      canvas.selectAll("#path_"+i)
            .style("display", "none")
            .attr("class", "")

    }




   })

  svg.selectAll(".team").style("fill", "white").style("stroke", "lightgray").style("stroke-width", 1)

    state_games.forEach(function(d, i) {

      if(d==1 || d==2) {
        svg.select("#game_"+all_end_games[i]).select("rect").style("fill", "yellow")

      } else if(d==3) {
          svg.select("#game_"+all_end_games[i]).select("rect").style("stroke", "gold").style("stroke-width", 2)
       
      } else if(d==4 || d == 6) {
       svg.select("#game_"+all_end_games[i]).select("rect").style("fill", "gold")
    }
     
    })

}

function draw_path(path_id, team, duration, delay) {

  var list_coordinates = all_paths[path_id].map(function(d) { return get_team_coordinates(d); })
                                           .filter(function(d) { return d == null ? false: true;})

  // Required for dragit
  //gDragit = svg.insert("g").attr("class", "gDragit")

  dragit.lineGraph = svg.selectAll("path_"+team)
                  .data([list_coordinates])
                .enter().append("path")
                  .attr("d", svgLine)
                  .attr("fill", "none")
                  //.transition().delay(delay)
                 
                  .style("stroke", "#000")

                  .attr("stroke-width", 1)    
                  .style("opacity", 0)                        
                  .attr("id", "path_"+team)
                  .attr("gid", "game_"+find_latest_game_path(all_paths[path_id]))
                  .style("display", "none")
                 // .attr("class", "path_"+team)
                  .style("pointer-events", "none")
                 // .call(transition);

}

// Return the #game_ node position as coordinate
function get_team_coordinates(team_id) {

  if(team_id == "XXX" || d3.select("#game_"+team_id)[0][0] == null) {
    return null;
  }


  // Game node
  var game_coords = d3.transform(d3.select(d3.select("#game_"+team_id).node().parentNode).attr("transform")).translate;
  
  // Team node
  var team_coords = d3.transform(d3.select("#game_"+team_id).attr("transform")).translate;

  return [game_coords[0] + team_coords[0], game_coords[1] + team_coords[1]];
}

function find_team_group(team) {
  return data.teams.filter(function(d) { return d.alias == team ? true : false; })[0].group;
} 

function find_teams_by_group(group) {
  return data.teams.filter(function(d) { return d.group == group ? true : false; })
}

// Return the paths containing a specific game
function filter_paths_by_game(g, paths) {
  return paths.filter(function(d) { return d.indexOf(g) != -1 ? d : false });
}

function filter_paths_by_team(t, paths) {
  return paths.filter(function(d) { return d.indexOf(t+"0") != -1 ? d : false });
}

function find_game_by_team_predictions(team, prediction) {
  return prediction.filter(function(d) { return d[1] == team; })[0] || false;
}

function find_team_by_game_predictions(game, prediction) {
  return prediction.filter(function(d) { return d[0] == game; })[0] || false;
}

// Return true if team can play this game
function test_team_play_game(team, game) {
    var game_paths = filter_paths_by_game(game, all_paths);
    var current_paths = filter_paths_by_team(team, game_paths);
    return current_paths.length > 0;
}

function test_occupied_game(game, prediction) {
  return prediction.filter(function(d) {
    return d[0] == game;
  }).length > 0;
}


function highlight_team(team, duration, delay) {

//  if(reset)
//    svg.selectAll(".lineTrail").remove();

  all_paths.filter(function(d, i) {

    d.filter(function(e, j) {
      if(e==team) {
         draw_path(i, team, duration, delay);
    //     move_team_flag(d[0].slice(0, 3), find_latest_game_path(d));
      }

    })

  })
}

function find_path_by_team(team, path) {

  return path.filter(function(d) {
    if(team + "0" == d)
      return d;
  }).length > 0;

}

function find_latest_game_path(path) {

  var index = 0;

  while(path[index]=="XXX" && index < path.length-1) {
    index++;
  }

  return path[index];

}

// Can a team play the given game?
function test_team_game(team, game) {

  var list_paths = [];

  all_paths.forEach(function(d, i) {

    if(d[0].slice(0, 3) == team) {   

      // Is there any path 
      var latest_game = find_latest_game_path(d);
      if(latest_game == game) {
        list_paths.push(i);
      }

    }

  })

  return list_paths;

}

function move_team_flag(team, game, duration, delay, ghost) {


  if (typeof delay === 'undefined') {
    delay = 100;
  }

  if (typeof ghost === 'undefined') {
    ghost = false;
  }


  if (typeof duration == 'undefined') {
    delay = 500;
  }

  var coords = get_team_coordinates(game);
  
  d3.select("#flag_"+team)
    .transition().duration(duration).delay(delay)
    .attr({"x": function(e, j) { return coords[0]+80; }, "y": function(e, j) { return coords[1]+40; }}) 

  if(ghost) {//} && team !=current_team) {


  d3.select("#flag2_"+team)
    .transition().duration(duration).delay(delay)
    .attr({"x": function(e, j) { return coords[0]+80; }, "y": function(e, j) { return coords[1]+40; }}) 
     .attr("transform", "translate(0, 0)")

  }

}

function display_ghost() {
   d3.select("#flag2_"+current_team).style("opacity", .5)
}

function update_flags(d, i) {

  // Move to the final point of the path

  // Error
  if(typeof dragit.data[dragit.trajectory.index_min] == "undefined")
    return

  var coords = dragit.data[dragit.trajectory.index_min][0];

  d3.select("#flag2_"+d.alias)
    .transition().duration(0).delay(0)
     .attr("transform", "translate(0, 0)")
    .attr({"x": function(e, j) { return coords[0]+80; }, "y": function(e, j) { return coords[1]+45; }}).style("opacity", 0)

  // Check if game already occupied in prediction

  if(!test_occupied_game(current_game, current_prediction)) {

    if(prevent_second_round && current_game[0] != "r") { // Can only reach a first round spot

      if(dev)
        console.log("Back to home", current_team+"0", current_path, d, current_game)
      
      // Move back to its original place
      move_team_flag(current_team, current_team+"0", 100, 0, true);

    } else {

      if(dev)
        console.log("PLMETY OF SPOT", current_path)

//    move_team_flag_path_anim(current_team, current_path, 100, false);

    move_team_flag(current_team, current_game, 100, 0, true);


    current_prediction = remove_team_prediction(current_team, current_prediction);
    current_prediction = add_team_game_prediction(current_team, current_game, current_prediction, false);

}


   // display_prediction(current_prediction, []);
  } else {
    
    // Move back to origin
    ///move_team_flag_path_anim(current_team, current_path, 100, true);
    console.log("Back to home", current_team+"0", "occupied", current_game)
    // Move back to original place
    move_team_flag(current_team, current_team+"0", 100, 0, true);

  }

}


// Create a random prediction and displays it
function simulate_tournament() {

  get_details("SIMULATE_TOURNAMENT")

  reversed_all_end_games = duplicate_array(all_end_games);
  reversed_all_end_games.reverse();

  list_teams = data.teams.map(function(d) { 
    return d.alias; 
  })

  // If tournament started, keep it
  if(current_prediction.length < data.teams.length) {

    list_teams = list_teams.filter(function(d) {
      if(!test_team_in_prediction(d, current_prediction))
        return d;
    })

    reversed_all_end_games = reversed_all_end_games.filter(function(d) {
      if(!test_game_in_prediction(d, current_prediction))
        return d;
    })

  } else {
    current_prediction = [];
  }


  // Randomize array
  list_teams.sort(function() {
    return Math.random() - 0.5;
  });

  var simulated_prediction = []


  // Fill the non-qualified teams first

  while(reversed_all_end_games.length > 0) {

    var candidate_game = reversed_all_end_games.shift();
    var candidate_team = list_teams.shift();
    var nb_try = 100;

    while(!test_team_play_game(candidate_team, candidate_game) && !test_team_in_prediction(candidate_team, simulated_prediction.concat(current_prediction)) && nb_try > 0) {

      // Put back the team
      list_teams.push(candidate_team);
      console.log(list_teams, simulated_prediction.length, nb_try)
      candidate_team = list_teams.shift();

      nb_try--;
    }

    if(nb_try<= 0) {
      if(dev)
        console.log("--------------GAVE UP", candidate_team, candidate_game)
    //  reversed_all_end_games.push(candidate_game);
    //  list_teams.push(candidate_team);
    } else {

      simulated_prediction.push([candidate_game, candidate_team]);
      if(dev)
        console.log(candidate_team, "--->", candidate_game)

    }


  }

  if(dev)
    console.log("ended simulation with nb game left", reversed_all_end_games)

  simulated_prediction = simulated_prediction.concat(current_prediction);
  display_prediction(simulated_prediction, current_prediction)
  current_prediction = simulated_prediction;
  update_url();
  update_paths();
}





function find_teams_by_group(group) {
  return data.teams.filter(function(d) { return d.group == group})
}

function test_team_in_prediction(team, prediction) {
  return prediction.filter(function(d, i) {
      if(d[1] == team)
        return d;
    }).length > 0;
}

function test_game_in_prediction(game, prediction) {
  return prediction.filter(function(d, i) {
      if(d[0] == game)
        return d;
    }).length > 0;
}

function reset_tournament() {

  get_details("RESET_TOURNAMENT")

  display_prediction([], current_prediction);
  current_prediction = [];

  data.teams.forEach(function(t) {

    move_team_flag(t.alias, t.alias+"0", 100, 0, true);

  })

  update_url();
  update_paths();
}

// Predictions look like that: var predictions = [ ["W62", "FRA"],  ["W61", "BRA"] ];
function display_prediction(new_prediction, old_prediction) {

  // Put back the teams which are not in the prediction anymore..
  var diff_teams = diff_prediction(new_prediction, old_prediction);

////// TOFIX
  data.teams.forEach(function(d, i) {

  //  move_team_flag(d.alias, d.alias+"0", 400, 400, true);
  })

  new_prediction.forEach(function(d, i) {

    var game_paths = filter_paths_by_game(d[0], all_paths);
    var current_paths = filter_paths_by_team(d[1], game_paths);

    var index_path = all_paths.indexOf(current_paths[0])


    //move_team_flag_path_anim(d[1], index_path, i*100, false)
    move_team_flag(d[1], d[0], 100, 0, true);

   var coords = get_team_coordinates(d[0]);

     d3.select("#flag2_"+d[1])
      .transition().duration(100).delay(100)
      .attr({"x": function(e, j) { return coords[0]+80; }, "y": function(e, j) { return coords[1]+45; }}) 
      .attr("transform", "translate(0, 0)")
      .each("start", function() {
        d3.select(this).style("opacity", 0)
      })
  })

}
  
function add_team_game_prediction(team, game, prediction, replace) {

  remove_team_prediction(team, prediction);
  prediction.push([game, team]);

  // Remove the team that using the current game position
  if(replace) {

  }

  return prediction;
}

// Make sure not already in it, if it is then remove it
function remove_team_prediction(team, prediction) {
  
  return prediction.filter(function(d, i) {
    if(d[1] != team)
      return d;
  })

}

// Return the one in 1 but not in 2
function diff_prediction(prediction1, prediction2) {
 return prediction1.filter(function(d) { return prediction2.indexOf(d) < 0;});

}

function store_current_team(d, i) {
  current_team = d.alias;
  current_prediction = remove_team_prediction(current_team, current_prediction);
}


function duplicate_trajectory(t) {
  return t.map(function(d, i) { return d; });
}

function duplicate_array(a) {
  return a.map(function(d, i) { return d; });
}

function decode_url() {
  var queryParameters = [];
      // Creates a map with the query string parameters
  while (m = re.exec(queryString)) {
      queryParameters.push([decodeURIComponent(m[1]), decodeURIComponent(m[2])]);
  }
  return queryParameters;
}

function update_url(update) {

  if (typeof update == 'undefined') {
    update = true;
  }

  var queryParameters = "";
  queryParameters = current_prediction.map(function(d) { return d[0]+"="+d[1]; }).join("&");
  var new_url = window.location.origin+window.location.pathname+"?"+queryParameters;
  if(update) {
    history.replaceState({}, "Title", new_url);
    d3.select("#new-url").attr("href", new_url)

  }
  return queryParameters;
}

function get_details(state) {
  
  d3.text("php/details.php?state="+state+"&"+update_url(false), function() {})

}

// Credits: http://bl.ocks.org/mbostock/5649592
function transition(path) {
  path.transition()
      //.delay(70500*Math.random())
      //.duration(7500*Math.random())
      .attrTween("stroke-dasharray", tweenDash)
      .style("opacity", .1)
      .each("end", function() { d3.select(this).call(transition); });
}

function tweenDash() {
  var l = this.getTotalLength(),
      i = d3.interpolateString("0," + l, l + "," + l);
  return function(t) { return i(t); };
}


function closestPoint(pathNode, point) {
  var pathLength = pathNode.getTotalLength(),
      precision = pathLength / pathNode.pathSegList.numberOfItems * .125,
      best,
      bestLength,
      bestDistance = Infinity;

  // linear scan for coarse approximation
  for (var scan, scanLength = 0, scanDistance; scanLength <= pathLength; scanLength += precision) {
    if ((scanDistance = distance2(scan = pathNode.getPointAtLength(scanLength))) < bestDistance) {
      best = scan, bestLength = scanLength, bestDistance = scanDistance;
    }
  }

  // binary search for precise estimate
  precision *= .5;
  while (precision > .5) {
    var before,
        after,
        beforeLength,
        afterLength,
        beforeDistance,
        afterDistance;
    if ((beforeLength = bestLength - precision) >= 0 && (beforeDistance = distance2(before = pathNode.getPointAtLength(beforeLength))) < bestDistance) {
      best = before, bestLength = beforeLength, bestDistance = beforeDistance;
    } else if ((afterLength = bestLength + precision) <= pathLength && (afterDistance = distance2(after = pathNode.getPointAtLength(afterLength))) < bestDistance) {
      best = after, bestLength = afterLength, bestDistance = afterDistance;
    } else {
      precision *= .5;
    }
  }

  best = [best.x, best.y];
  best.distance = Math.sqrt(bestDistance);
  best.pathlength = bestLength;
  return best;

  function distance2(p) {
    var dx = p.x - point[0],
        dy = p.y - point[1];
    return dx * dx + dy * dy;
  }
}

// Credits: http://bl.ocks.org/mbostock/1705868
function move_team_flag_path_anim(team, which_path, delay, go_back) {

  if (typeof go_back == 'undefined') {
    go_back = true;
  }

  if (typeof delay == 'undefined') {
    delay = 0;
  }


  var path = d3.select("#path_"+which_path)//.attr("transform", "translate(" + 0 + ", " + 0+")");;

  var marker = d3.select("#flag_"+team)// svg.append("circle");
  
  var flag_x = parseInt(d3.select("#flag_"+team).attr("x"))-100; 
  var flag_y = parseInt(d3.select("#flag_"+team).attr("y"))-50; 

  var flag_point = [flag_x, flag_y];
  var progress = 0;
//  var path_point = path.node().getPointAtLength(progress);

  var path_point =  closestPoint(path.node(), flag_point);


  path_transition();

  if(go_back)
    console.log("REVERSEEEEEE")

  function path_transition() {
    marker.transition()
        .duration(path_point.pathlength)
        .delay(delay)
        .ease("linear")
        .attrTween("x", translateAlong_x(path.node()))
        .attrTween("y", translateAlong_y(path.node()))
     //   .each("end", path_transition);// infinite loop
     //TODO: move to exact positions
  }
  
  function translateAlong_x(path) {
    var l = path_point.pathlength; //path.getTotalLength(); // should be remaining path
     if(go_back)
      l = path.getTotalLength() - l;; // should be remaining path
    return function(i) {
      return function(t) {
        var p = path.getPointAtLength(l - t * l);
        if(go_back)
          p = path.getPointAtLength(t * l);
        return p.x+80;
      }
    }
  }

  function translateAlong_y(path) {
    var l = path_point.pathlength;
    if(go_back)
      l = path.getTotalLength() - l;; // should be remaining path
    return function(i) {
      return function(t) {
        var p = path.getPointAtLength(l - t * l);
        if(go_back)
          p = path.getPointAtLength(t * l);
        return p.y+40;
      }
    }
  }

}

// Custom easing: http://bl.ocks.org/mbostock/5743979 (Not used)
function bounce(h) {
  if (!arguments.length) h = 0.25;
  var b0 = 1 - h,
      b1 = b0 * (1 - b0) + b0,
      b2 = b0 * (1 - b1) + b1,
      x0 = 2 * Math.sqrt(h),
      x1 = x0 * Math.sqrt(h),
      x2 = x1 * Math.sqrt(h),
      t0 = 1 / (1 + x0 + x1 + x2),
      t1 = t0 + t0 * x0,
      t2 = t1 + t0 * x1,
      m0 = t0 + t0 * x0 / 2,
      m1 = t1 + t0 * x1 / 2,
      m2 = t2 + t0 * x2 / 2,
      a = 1 / (t0 * t0);
  return function(t) {
    return t >= 1 ? 1
        : t < t0 ? a * t * t
        : t < t1 ? a * (t -= m0) * t + b0
        : t < t2 ? a * (t -= m1) * t + b1
        : a * (t -= m2) * t + b2;
  };
}

// Credits: https://dev.twitter.com/discussions/890
function updateTwitterValues() {
  var share_url = window.location.href;
  var title = "Another prediction for the #WorldCup14";
  var original_url = "http://romain.vuillemot.net/projects/worldcup14/";
// clear out the <a> tag that's currently there...probably don't really need this since you're replacing whatever is in there already.
  d3.select(".twitter-share-container").html('&nbsp;'); 
  d3.select(".twitter-share-container").html('<a href="https://twitter.com/share" class="twitter-share-button" data-url="' + share_url +'" data-via="romsson" data-size="small" data-counturl="' + original_url + '" data-text="' + title + '" >Tweet</a>');

  setTimeout(function() {twttr.widgets.load();}, 500);
}
